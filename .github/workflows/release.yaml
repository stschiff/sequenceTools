name: Release
on:
  # Trigger the workflow on the new 'v*' tag created
  push:
    tags:
      - "v*"

jobs:
  create_release:
    name: Create Github Release
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Create Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          name: Release ${{ github.ref_name }}
          draft: true

  # build-on-centos:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Checkout repo
  #     uses: actions/checkout@v2
    
  #   - name: Build Docker image
  #     run: docker build -t linux -f Dockerfile.linux .
    
  #   - name: Create container
  #     run: docker create --name linuxcontainer linux
    
  #   - name: Copy executable
  #     run: |
  #       for TOOL in genoStats pileupCaller vcf2eigenstrat; do
  #         docker cp linuxcontainer:/root/.local/bin/$TOOL $TOOL-linux
  #       done
    
  #   - name: update-release
  #     run: |
  #       for TOOL in genoStats pileupCaller vcf2eigenstrat; do
  #         bash .github/workflows/upload-github-release-asset.sh github_api_token=${{ secrets.GITHUB_TOKEN }} owner=stschiff repo=sequenceTools tag=$(basename $GITHUB_REF) filename=$TOOL-linux
  #       done
  
  build-on-mac:
    runs-on: macos-latest
    steps:
    
    - name: Checkout repo
      uses: actions/checkout@v2
    
    - name: Setup Haskell
      uses: haskell/actions/setup@v1
      with:
        enable-stack: true
    
    - name: Build
      run: stack install
    
    - name: Rename binaries
      run: |
        for TOOL in genoStats pileupCaller vcf2eigenstrat; do cp ~/.local/bin/$TOOL $TOOL-macOS; done

    - name: Upload Release Asset
      id: upload-release-asset
      uses: ncipollo/release-action@v1
      with:
        name: Release ${{ github.ref_name }}
        draft: true
        allowUpdates: true
        artifactErrorsFailBuild: true
        artifacts: "genoStats-macOS,pileupCaller-macOS,vcf2eigenstrat-macOS"
        artifactContentType: application/octet-stream
    